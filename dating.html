<!DOCTYPE html>
<html>
<head>
  <title>Send Like (with Auth)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h2>Like Someone (Secure)</h2>
  <form id="likeForm">
    <label>Roll Number:</label><br>
    <input type="number" id="roll_number" required><br><br>

    <label>Password:</label><br>
    <input type="password" id="password" required><br><br>

    <label>Who You Like (Roll No.):</label><br>
    <input type="number" id="likes" required><br><br>

    <button type="submit">Submit</button>
  </form>

  <p id="status"></p>

  <script>
     window.addEventListener('DOMContentLoaded', async () =>{
        const createClient = window.supabase.createClient;
     supabase = createClient('https://wtufaboilvzfkjzzlnwt.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0dWZhYm9pbHZ6Zmtqenpsbnd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE4NzEzNjEsImV4cCI6MjA2NzQ0NzM2MX0.ntK7eFoQKamWwRaQH5Qs8J7XrtqaFPoj45wkX6aN2dI');

    document.getElementById('likeForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const roll_number = document.getElementById('roll_number').value;
      const password = document.getElementById('password').value;
      const likes = document.getElementById('likes').value;
      const status = document.getElementById('status');

      const email = `${roll_number}@nitkkr.ac.in`;

      // Step 1: Login user
      const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({
        email,
        password
      });

      if (loginError) {
        status.textContent = 'âŒ Login failed: ' + loginError.message;
        return;
      }

      // Step 2: Update likes for this roll number
      const { data: updateData, error: updateError } = await supabase
        .from('students')
        .update({ likes: likes })
        .eq('roll_number', roll_number);

      if (updateError) {
        status.textContent = 'âŒ Failed to update: ' + updateError.message;
        return;
      }

      // Step 3: Check mutual like
      const { data: likedUser, error: likeFetchError } = await supabase
        .from('students')
        .select('likes')
        .eq('roll_number', likes);

      if (likedUser.length > 0 && likedUser[0].likes == roll_number) {
        // Update both records' liked = 1
        await supabase
          .from('students')
          .update({ liked: '1' })
          .in('roll_number', [roll_number, likes]);

        status.textContent = 'ðŸ’˜ Match found!';
      } else {
        status.textContent = 'âœ… Like submitted. Waiting for mutual like.';
      }

      document.getElementById('likeForm').reset();
    });
});
  </script>
</body>
</html>
